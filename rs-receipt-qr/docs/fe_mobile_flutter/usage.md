# Инструкции по использованию fe_mobile_flutter

## Новая архитектура обработки QR кодов

**Важно**: Логика обработки QR кодов изменена! Теперь вся обработка происходит на backend.

### Поток работы:
1. Flutter сканирует QR код
2. Отправляет сырой URL на backend (`POST /api/receipt-raw`)
3. Backend сохраняет в `receipt_raw` со статусом "pending"
4. Backend асинхронно получает данные с tax.gov.me (каждые 30 секунд)
5. Flutter периодически опрашивает backend о статусе обработки
6. Когда статус "completed", Flutter загружает данные в локальную БД

---

## 1. Сканирование QR кода (обновленный процесс)
- Нажмите кнопку "Scan QR Code" на домашней странице.
- Отсканируйте QR код черногорского чека.
- Приложение выполнит:
  1. Извлечение URL из QR кода.
  2. Отправку URL на backend (`POST /api/receipt-raw`).
  3. Сохранение записи в локальную таблицу `receipt_raws` со статусом "pending".
  4. Отображение сообщения "QR код отправлен на обработку".

**Примечание**: Данные чека появятся не сразу! Backend обрабатывает QR коды асинхронно.

## 2. Синхронизация и polling
- Нажмите кнопку "Sync" на домашней странице.
- Приложение выполнит:
  1. Проверку статуса всех pending QR кодов (`GET /api/receipt-raw/{id}`).
  2. Для каждого "completed" чека - загрузку данных (`GET /api/receipt-raw/{id}/receipt`).
  3. Сохранение полученных чеков и позиций в локальную БД.
  4. Обновление статуса в `receipt_raws`.

**Статусы обработки**:
- `pending` - ожидает обработки
- `processing` - обрабатывается backend
- `completed` - готово, данные получены
- `failed` - ошибка при обработке

## 3. API Endpoints

### Backend endpoints:
- `POST /api/receipt-raw` - отправка QR URL
  ```json
  { "userId": 1, "url": "https://...?iic=...&crtd=...&tin=..." }
  ```
  Возвращает: `{ "receiptRawId": 123, "status": "pending" }`

- `GET /api/receipt-raw/{id}` - проверка статуса
  Возвращает: `{ "receiptRawId": 123, "status": "completed", "receiptId": 456 }`

- `GET /api/receipt-raw/{id}/receipt` - получение обработанного чека
  Возвращает: `{ "receipt": {...}, "items": [{...}] }`

## 4. Требования
- Убедитесь, что выполнена команда `flutter pub get` для установки зависимостей.
- Выполните `flutter pub run build_runner build --delete-conflicting-outputs` для генерации кода базы данных Drift (схема v3).
- Обновите URL бэкенда в `main.dart` и `sync_service.dart`.
- Backend должен быть запущен и доступен.

## 5. User ID
При первом запуске приложение создаст дефолтного пользователя и сохранит его ID в SharedPreferences. Все чеки будут привязаны к этому пользователю.

## 6. Примечания
- Приложение использует Drift для локального хранения (схема v3), HTTP для коммуникации с бэкендом, и `qr_code_scanner` для сканирования QR.
- Все данные хранятся локально для offline доступа.
- Обработка QR кодов происходит на backend асинхронно.
- Рекомендуется настроить автоматический polling (каждые 10-30 секунд) для проверки статусов.
 